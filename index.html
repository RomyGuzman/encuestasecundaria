<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-in-out;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
        }
        h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #444;
        }
        .option {
            display: block;
            margin: 10px 0;
            padding: 14px;
            border: 2px solid #2575fc;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            user-select: none;
        }
        .option:hover {
            background: #2575fc;
            color: white;
        }
        .option.selected {
            background: #2575fc !important;
            color: #fff !important;
            border-color: #2575fc !important;
        }
    
        input[type="radio"],
        input[type="checkbox"] {
            display: none;
        }
        button {
            margin-top: 15px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        .back-btn {
            background: #ddd !important;
            color: #333 !important;
            margin-right: 10px;
        }
        .back-btn:hover {
            background: #ccc !important;
            transform: scale(1.02);
        }
        .progress-bar {
            height: 8px;
            background: #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress {
            height: 8px;
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            width: 0;
            transition: width 0.4s ease;
        }
       
        .spinner div {
            width: 16px;
            height: 16px;
            margin: 0 4px;
            background: #2575fc;
            border-radius: 50%;
            animation: bounce 0.6s infinite alternate;
        }
        .spinner div:nth-child(2) {
            animation-delay: 0.2s;
        }
        .spinner div:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes bounce {
            to {
                transform: translateY(-12px);
                opacity: 0.7;
            }
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .button-group button {
            flex: 1;
            margin: 0 5px;
        }
        .final-message {
            text-align: center;
            font-size: 1rem;
            line-height: 1.5;
        }
        .final-message a {
            color: #2575fc;
            text-decoration: underline;
        }
        .multi-select-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }
        .error-msg-final {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ENCUESTA</h1>
        <div class="progress-bar"><div id="progress" class="progress"></div></div>
        <div id="quiz"></div>
    </div>
    <script>
        // Webhook URL - REEMPLAZA CON TU URL REAL DE N8N (ej. ngrok para pruebas externas, o localhost si n8n corre local)
        const N8N_WEBHOOK_URL = 'https://instituto-n8n.lyeztz.easypanel.host/webhook/Secundario';
        
        // Traducciones de preguntas y opciones (preguntas codificadas internamente en inglés via fieldMapping)
        const traducciones = {
            es: [
                { pregunta: "Edad: selecciona tu edad", opciones: ["12", "13", "14", "15", "16", "17"] },
                { pregunta: "Género", opciones: ["Femenino", "Masculino", "Otro"] },
                { pregunta: "¿Has apostado en línea alguna vez?", opciones: ["Sí", "No"] },
                { pregunta: "¿Con qué frecuencia sueles apostar?", opciones: ["1 a 2 días por semana", "3 a 5 días por semana", "6 a 7 días por semana"] },
                { pregunta: "¿Cuántas horas apostás por día?", opciones: ["Menos de 1 hora", "1 a 2 horas", "Más de 3 horas"] },
                { pregunta: "¿Qué días de la semana sueles apostar?", opciones: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"] },
                { pregunta: "¿En qué tipo de actividades apuestas?", opciones: ["Casino online", "Apuestas deportivas", "Póker u otros juegos de cartas", "Juegos de azar (ruleta, tragamonedas, etc.)", "Otro"] },
                { pregunta: "¿Los sitios de apuestas en los que juegas son oficiales (.bet)?", opciones: ["Sí", "No", "No sé"] },
                { pregunta: "¿De dónde obtienes el dinero para apostar?", opciones: ["Un familiar", "Trabajo", "Becas", "Otro"] },
                { pregunta: "¿Cuánto dinero sueles apostar en una semana?", opciones: ["Entre $1.000 y $5.000", "Entre $5.000 y $10.000", "Más de $10.000"] },
                { pregunta: "¿Tus padres o tutores saben que apuestas?", opciones: ["Sí", "No", "No estoy seguro"] },
                { pregunta: "¿Cómo conociste los juegos en línea?", opciones: ["Redes sociales", "Amigos", "Familia", "Otro"] },
                { pregunta: "¿Por qué apuestas?", opciones: ["Diversión o entretenimiento", "Para ganar dinero", "Porque mis amigos lo hacen", "Otro"] },
                { pregunta: "¿Conoces los riesgos de apostar?", opciones: ["Sí", "No"] },
                { pregunta: "¿Sabes a dónde acudir o qué hacer si tuvieras un problema con las apuestas?", opciones: ["Sí", "No"] },
                { pregunta: "¿Te gustaría recibir información al respecto?", opciones: ["Sí", "No"] },
                { pregunta: "¿Conoces a alguien que apueste en línea?", opciones: ["Sí", "No"] },
                { pregunta: "¿Alguien te ha recomendado apostar alguna vez?", opciones: ["Sí", "No"] },
                { pregunta: "¿Te gustaría apostar algún día?", opciones: ["Sí", "No", "No estoy seguro"] },
                { pregunta: "¿Conoces los riesgos de apostar?", opciones: ["Sí", "No", "Un poco"] },
                { pregunta: "¿Sabes a dónde acudir o qué hacer si tuvieras un problema con las apuestas?", opciones: ["Sí", "No"] },
                { pregunta: "¿Has visto anuncios de apuestas en línea en redes sociales o internet?", opciones: ["Sí, muchas veces", "Algunas veces", "Nunca"] },
                { pregunta: "¿Alguna vez has gastado dinero en un juego (ej.: para obtener monedas, vidas o recompensas)?", opciones: ["Sí", "No"] }
            ],
            en: [
                { pregunta: "Age: select your age", opciones: ["12", "13", "14", "15", "16", "17"] },
                { pregunta: "Gender", opciones: ["Female", "Male", "Other"] },
                { pregunta: "Have you ever bet online?", opciones: ["Yes", "No"] },
                { pregunta: "How often do you usually bet?", opciones: ["1 to 2 days per week", "3 to 5 days per week", "6 to 7 days per week"] },
                { pregunta: "How many hours do you bet per day?", opciones: ["Less than 1 hour", "1 to 2 hours", "More than 3 hours"] },
                { pregunta: "Which days of the week do you usually bet?", opciones: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] },
                { pregunta: "What type of activities do you bet on?", opciones: ["Online casino", "Sports betting", "Poker or other card games", "Games of chance (roulette, slots, etc.)", "Other"] },
                { pregunta: "Are the betting sites you play on official (.bet)?", opciones: ["Yes", "No", "I don't know"] },
                { pregunta: "Where do you get the money to bet?", opciones: ["A relative", "Work", "Scholarships", "Other"] },
                { pregunta: "How much money do you usually bet in a week?", opciones: ["Between $1,000 and $5,000", "Between $5,000 and $10,000", "More than $10,000"] },
                { pregunta: "Do your parents or guardians know you bet?", opciones: ["Yes", "No", "I'm not sure"] },
                { pregunta: "How did you learn about online games?", opciones: ["Social networks", "Friends", "Family", "Other"] },
                { pregunta: "Why do you bet?", opciones: ["Fun or entertainment", "To earn money", "Because my friends do it", "Other"] },
                { pregunta: "Do you know the risks of betting?", opciones: ["Yes", "No"] },
                { pregunta: "Do you know where to go or what to do if you had a problem with betting?", opciones: ["Yes", "No"] },
                { pregunta: "Would you like to receive information about it?", opciones: ["Yes", "No"] },
                { pregunta: "Do you know someone who bets online?", opciones: ["Yes", "No"] },
                { pregunta: "Has anyone ever recommended you to bet?", opciones: ["Yes", "No"] },
                { pregunta: "Would you like to bet someday?", opciones: ["Yes", "No", "I'm not sure"] },
                { pregunta: "Do you know the risks of betting?", opciones: ["Yes", "No", "A little"] },
                { pregunta: "Do you know where to go or what to do if you had a problem with betting?", opciones: ["Yes", "No"] },
                { pregunta: "Have you seen online betting ads on social networks or the internet?", opciones: ["Yes, many times", "Sometimes", "Never"] },
                { pregunta: "Have you ever spent money on a game (e.g., to get coins, lives or rewards)?", opciones: ["Yes", "No"] }
            ],
            zh: [
                { pregunta: "年龄：选择你的年龄", opciones: ["12", "13", "14", "15", "16", "17"] },
                { pregunta: "性别", opciones: ["女性", "男性", "其他"] },
                { pregunta: "你曾经在线上赌博过吗？", opciones: ["是", "否"] },
                { pregunta: "你通常多久赌博一次？", opciones: ["每周1-2天", "每周3-5天", "每周6-7天"] },
                { pregunta: "你每天赌博多少小时？", opciones: ["少于1小时", "1到2小时", "超过3小时"] },
                { pregunta: "你通常在哪些星期几赌博？", opciones: ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"] },
                { pregunta: "你参与哪些类型的赌博活动？", opciones: ["在线赌场", "体育博彩", "扑克或其他纸牌游戏", "机会游戏（轮盘、老虎机等）", "其他"] },
                { pregunta: "你玩的赌博网站是官方的吗（.bet）？", opciones: ["是", "否", "不知道"] },
                { pregunta: "你从哪里获得赌博资金？", opciones: ["亲属", "工作", "奖学金", "其他"] },
                { pregunta: "你一周通常赌博多少钱？", opciones: ["$1,000-$5,000", "$5,000-$10,000", "超过$10,000"] },
                { pregunta: "你的父母或监护人知道你赌博吗？", opciones: ["是", "否", "不确定"] },
                { pregunta: "你是如何了解线上游戏的？", opciones: ["社交网络", "朋友", "家庭", "其他"] },
                { pregunta: "你为什么赌博？", opciones: ["娱乐", "赚钱", "因为朋友也赌博", "其他"] },
                { pregunta: "你知道赌博的风险吗？", opciones: ["是", "否"] },
                { pregunta: "如果你在赌博中遇到问题，你知道该去哪里或该怎么办吗？", opciones: ["是", "否"] },
                { pregunta: "你想收到相关信息吗？", opciones: ["是", "否"] },
                { pregunta: "你认识有人在线赌博吗？", opciones: ["是", "否"] },
                { pregunta: "有人曾经推荐你赌博吗？", opciones: ["是", "否"] },
                { pregunta: "你想过有一天去赌博吗？", opciones: ["是", "否", "不确定"] },
                { pregunta: "你知道赌博的风险吗？", opciones: ["是", "否", "有一点"] },
                { pregunta: "如果你在赌博中遇到问题，你知道该去哪里或该怎么办吗？", opciones: ["是", "否"] },
                { pregunta: "你在社交网络或互联网上见过线上赌博广告吗？", opciones: ["是，经常", "有时", "从未"] },
                { pregunta: "你曾经在游戏中花钱吗（例如：购买金币、生命或奖励）？", opciones: ["是", "否"] }
            ]
        };

        // Estructura base de preguntas (en español, para tipos)
        const questions = [
            { pregunta: "Edad: selecciona tu edad", tipo: "opcion", opciones: ["12", "13", "14", "15", "16", "17"] },
            { pregunta: "Género", tipo: "opcion", opciones: ["Femenino", "Masculino", "Otro"] },
            { pregunta: "¿Has apostado en línea alguna vez?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Con qué frecuencia sueles apostar?", tipo: "opcion", opciones: ["1 a 2 días por semana", "3 a 5 días por semana", "6 a 7 días por semana"] },
            { pregunta: "¿Cuántas horas apostás por día?", tipo: "opcion", opciones: ["Menos de 1 hora", "1 a 2 horas", "Más de 3 horas"] },
            { pregunta: "¿Qué días de la semana sueles apostar?", tipo: "multiple", opciones: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"] },
            { pregunta: "¿En qué tipo de actividades apuestas?", tipo: "multiple", opciones: ["Casino online", "Apuestas deportivas", "Póker u otros juegos de cartas", "Juegos de azar (ruleta, tragamonedas, etc.)", "Otro"] },
            { pregunta: "¿Los sitios de apuestas en los que juegas son oficiales (.bet)?", tipo: "opcion", opciones: ["Sí", "No", "No sé"] },
            { pregunta: "¿De dónde obtienes el dinero para apostar?", tipo: "opcion", opciones: ["Un familiar", "Trabajo", "Becas", "Otro"] },
            { pregunta: "¿Cuánto dinero sueles apostar en una semana?", tipo: "opcion", opciones: ["Entre $1.000 y $5.000", "Entre $5.000 y $10.000", "Más de $10.000"] },
            { pregunta: "¿Tus padres o tutores saben que apuestas?", tipo: "opcion", opciones: ["Sí", "No", "No estoy seguro"] },
            { pregunta: "¿Cómo conociste los juegos en línea?", tipo: "opcion", opciones: ["Redes sociales", "Amigos", "Familia", "Otro"] },
            { pregunta: "¿Por qué apuestas?", tipo: "opcion", opciones: ["Diversión o entretenimiento", "Para ganar dinero", "Porque mis amigos lo hacen", "Otro"] },
            { pregunta: "¿Conoces los riesgos de apostar?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Sabes a dónde acudir o qué hacer si tuvieras un problema con las apuestas?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Te gustaría recibir información al respecto?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Conoces a alguien que apueste en línea?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Alguien te ha recomendado apostar alguna vez?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Te gustaría apostar algún día?", tipo: "opcion", opciones: ["Sí", "No", "No estoy seguro"] },
            { pregunta: "¿Conoces los riesgos de apostar?", tipo: "opcion", opciones: ["Sí", "No", "Un poco"] },
            { pregunta: "¿Sabes a dónde acudir o qué hacer si tuvieras un problema con las apuestas?", tipo: "opcion", opciones: ["Sí", "No"] },
            { pregunta: "¿Has visto anuncios de apuestas en línea en redes sociales o internet?", tipo: "opcion", opciones: ["Sí, muchas veces", "Algunas veces", "Nunca"] },
            { pregunta: "¿Alguna vez has gastado dinero en un juego (ej.: para obtener monedas, vidas o recompensas)?", tipo: "opcion", opciones: ["Sí", "No"] }
        ];

        // Mapeo de preguntas (índice 0-22) a keys en inglés para el JSON/BD (codificación en inglés)
        const fieldMapping = {
            0: 'age',
            1: 'gender',
            2: 'ever_bet_online',
            3: 'betting_frequency',
            4: 'hours_per_day',
            5: 'betting_days',
            6: 'betting_activities',
            7: 'official_sites',
            8: 'money_sources',
            9: 'weekly_bet_amount',
            10: 'parents_know',
            11: 'how_discovered_online_games',
            12: 'reasons_for_betting',
            13: 'know_betting_risks',
            14: 'know_where_to_seek_help',
            15: 'want_information',
            16: 'knows_someone_who_bets',
            17: 'recommended_to_bet',
            18: 'want_to_bet_someday',
            19: 'know_risks_level',
            20: 'know_help_for_problems',
            21: 'seen_betting_ads',
            22: 'spent_money_on_games'
        };

        // Mapeo de valores de respuestas a español (independientemente del idioma elegido, para guardado en BD)
        // Para opciones simples (Sí/No, etc.), y para múltiples se envía array en español
        const valueToSpanish = {
            // Pregunta 0: Edad (numérica, igual en todos)
            0: { '12': '12', '13': '13', '14': '14', '15': '15', '16': '16', '17': '17' },
            // Pregunta 1: Género
            1: { 
                'Femenino': 'Femenino', 'Masculino': 'Masculino', 'Otro': 'Otro',
                'Female': 'Femenino', 'Male': 'Masculino', 'Other': 'Otro',
                '女性': 'Femenino', '男性': 'Masculino', '其他': 'Otro'
            },
            // Pregunta 2: Ever bet online
            2: { 
                'Sí': 'Sí', 'No': 'No',
                'Yes': 'Sí', 'No': 'No',  // 'No' es igual
                '是': 'Sí', '否': 'No'
            },
            // Pregunta 3: Frecuencia
            3: {
                '1 a 2 días por semana': '1 a 2 días por semana', '3 a 5 días por semana': '3 a 5 días por semana', '6 a 7 días por semana': '6 a 7 días por semana',
                '1 to 2 days per week': '1 a 2 días por semana', '3 to 5 days per week': '3 a 5 días por semana', '6 to 7 days per week': '6 a 7 días por semana',
                '每周1-2天': '1 a 2 días por semana', '每周3-5天': '3 a 5 días por semana', '每周6-7天': '6 a 7 días por semana'
            },
            // Pregunta 4: Horas
            4: {
                'Menos de 1 hora': 'Menos de 1 hora', '1 a 2 horas': '1 a 2 horas', 'Más de 3 horas': 'Más de 3 horas',
                'Less than 1 hour': 'Menos de 1 hora', '1 to 2 hours': '1 a 2 horas', 'More than 3 hours': 'Más de 3 horas',
                '少于1小时': 'Menos de 1 hora', '1到2小时': '1 a 2 horas', '超过3小时': 'Más de 3 horas'
            },
            // Pregunta 5: Días (múltiples, mapear cada uno)
            5: {
                'Lunes': 'Lunes', 'Martes': 'Martes', 'Miércoles': 'Miércoles', 'Jueves': 'Jueves', 'Viernes': 'Viernes', 'Sábado': 'Sábado', 'Domingo': 'Domingo',
                'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Miércoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'Sábado', 'Sunday': 'Domingo',
                '星期一': 'Lunes', '星期二': 'Martes', '星期三': 'Miércoles', '星期四': 'Jueves', '星期五': 'Viernes', '星期六': 'Sábado', '星期日': 'Domingo'
            },
            // Pregunta 6: Actividades (múltiples)
            6: {
                'Casino online': 'Casino online', 'Apuestas deportivas': 'Apuestas deportivas', 'Póker u otros juegos de cartas': 'Póker u otros juegos de cartas', 'Juegos de azar (ruleta, tragamonedas, etc.)': 'Juegos de azar (ruleta, tragamonedas, etc.)', 'Otro': 'Otro',
                'Online casino': 'Casino online', 'Sports betting': 'Apuestas deportivas', 'Poker or other card games': 'Póker u otros juegos de cartas', 'Games of chance (roulette, slots, etc.)': 'Juegos de azar (ruleta, tragamonedas, etc.)', 'Other': 'Otro',
                '在线赌场': 'Casino online', '体育博彩': 'Apuestas deportivas', '扑克或其他纸牌游戏': 'Póker u otros juegos de cartas', '机会游戏（轮盘、老虎机等）': 'Juegos de azar (ruleta, tragamonedas, etc.)', '其他': 'Otro'
            },
            // Pregunta 7: Sitios oficiales
            7: {
                'Sí': 'Sí', 'No': 'No', 'No sé': 'No sé',
                'Yes': 'Sí', 'No': 'No', "I don't know": 'No sé',
                '是': 'Sí', '否': 'No', '不知道': 'No sé'
            },
            // Pregunta 8: Fuentes de dinero
            8: {
                'Un familiar': 'Un familiar', 'Trabajo': 'Trabajo', 'Becas': 'Becas', 'Otro': 'Otro',
                'A relative': 'Un familiar', 'Work': 'Trabajo', 'Scholarships': 'Becas', 'Other': 'Otro',
                '亲属': 'Un familiar', '工作': 'Trabajo', '奖学金': 'Becas', '其他': 'Otro'
            },
            // Pregunta 9: Cantidad semanal
            9: {
                'Entre $1.000 y $5.000': 'Entre $1.000 y $5.000', 'Entre $5.000 y $10.000': 'Entre $5.000 y $10.000', 'Más de $10.000': 'Más de $10.000',
                'Between $1,000 and $5,000': 'Entre $1.000 y $5.000', 'Between $5,000 and $10,000': 'Entre $5.000 y $10.000', 'More than $10,000': 'Más de $10.000',
                '$1,000-$5,000': 'Entre $1.000 y $5.000', '$5,000-$10,000': 'Entre $5.000 y $10.000', '超过$10,000': 'Más de $10.000'
            },
            // Pregunta 10: Padres saben
            10: {
                'Sí': 'Sí', 'No': 'No', 'No estoy seguro': 'No estoy seguro',
                'Yes': 'Sí', 'No': 'No', "I'm not sure": 'No estoy seguro',
                '是': 'Sí', '否': 'No', '不确定': 'No estoy seguro'
            },
            // Pregunta 11: Cómo conociste
            11: {
                'Redes sociales': 'Redes sociales', 'Amigos': 'Amigos', 'Familia': 'Familia', 'Otro': 'Otro',
                'Social networks': 'Redes sociales', 'Friends': 'Amigos', 'Family': 'Familia', 'Other': 'Otro',
                '社交网络': 'Redes sociales', '朋友': 'Amigos', '家庭': 'Familia', '其他': 'Otro'
            },
            // Pregunta 12: Por qué
            12: {
                'Diversión o entretenimiento': 'Diversión o entretenimiento', 'Para ganar dinero': 'Para ganar dinero', 'Porque mis amigos lo hacen': 'Porque mis amigos lo hacen', 'Otro': 'Otro',
                'Fun or entertainment': 'Diversión o entretenimiento', 'To earn money': 'Para ganar dinero', 'Because my friends do it': 'Porque mis amigos lo hacen', 'Other': 'Otro',
                '娱乐': 'Diversión o entretenimiento', '赚钱': 'Para ganar dinero', '因为朋友也赌博': 'Porque mis amigos lo hacen', '其他': 'Otro'
            },
            // Pregunta 13: Riesgos
            13: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 14: Dónde acudir
            14: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 15: Info
            15: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 16: Conoces alguien
            16: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 17: Recomendado
            17: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 18: Quieres apostar
            18: { 
                'Sí': 'Sí', 'No': 'No', 'No estoy seguro': 'No estoy seguro',
                'Yes': 'Sí', 'No': 'No', "I'm not sure": 'No estoy seguro',
                '是': 'Sí', '否': 'No', '不确定': 'No estoy seguro'
            },
            // Pregunta 19: Riesgos nivel
            19: { 
                'Sí': 'Sí', 'No': 'No', 'Un poco': 'Un poco',
                'Yes': 'Sí', 'No': 'No', 'A little': 'Un poco',
                '是': 'Sí', '否': 'No', '有一点': 'Un poco'
            },
            // Pregunta 20: Ayuda problemas
            20: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' },
            // Pregunta 21: Anuncios
            21: {
                'Sí, muchas veces': 'Sí, muchas veces', 'Algunas veces': 'Algunas veces', 'Nunca': 'Nunca',
                'Yes, many times': 'Sí, muchas veces', 'Sometimes': 'Algunas veces', 'Never': 'Nunca',
                '是，经常': 'Sí, muchas veces', '有时': 'Algunas veces', '从未': 'Nunca'
            },
            // Pregunta 22: Gastado dinero
            22: { 'Sí': 'Sí', 'No': 'No', 'Yes': 'Sí', '是': 'Sí' }
        };

        let currentQuestionIndex = 0;
        let answers = {};  // Almacena respuestas en el idioma mostrado, pero se mapearán a español al enviar
        let questionFlow = [0, 1, 2]; // Siempre empieza con las primeras 3 preguntas
        let currentLang = 'es';
        let surveyStarted = false;  // Bloquea cambio de idioma después de empezar
        let currentFlowIndex = 0;

        function cambiarIdioma(lang) {
    currentLang = lang;
    document.getElementById('lang').value = lang;  // Actualiza el selector visualmente
    mostrarPregunta();  // Refresca la pregunta en el nuevo idioma
}


        function getQuestionText(questionIndex) {
            const trad = traducciones[currentLang][questionIndex];
            const baseQ = questions[questionIndex];
            return {
                pregunta: trad.pregunta,
                tipo: baseQ.tipo,
                opciones: trad.opciones
            };
        }

        function updateQuestionFlow() {
            const question3Answer = answers[2];  // Respuesta a pregunta 3 (índice 2)
            const yesValues = ['Sí', 'Yes', '是'];  // Detecta "Sí" en cualquier idioma
            const newFlow = [0, 1, 2];
            
            if (yesValues.includes(question3Answer)) {
                // Path "Sí": Preguntas 4 a 16 (índices 3-15), luego salta a Preg 23 (índice 22)
                for (let i = 3; i <= 15; i++) {
                    newFlow.push(i);
                }
                newFlow.push(22);  // Siempre termina en la última pregunta (22)
            } else {
                // Path "No": Salta a Preg 17 (índice 16) hasta 22
                for (let i = 16; i <= 22; i++) {
                    newFlow.push(i);
                }
            }
            
            questionFlow = newFlow;
            console.log('Nuevo flujo:', questionFlow);  // Debug, puedes remover
        }

        function mostrarPregunta() {
    surveyStarted = true;  // Mantiene el bloqueo para otras lógicas si es necesario, pero no afecta idioma
    const realQuestionIndex = questionFlow[currentFlowIndex];
    const questionData = getQuestionText(realQuestionIndex);

    let html = '';

    // Selector de idioma SOLO en la primera pregunta (currentFlowIndex === 0)
    if (currentFlowIndex === 0) {
        html += `
            <div style="text-align:right; margin-bottom:10px;">
                <label for="lang">Idioma:</label>
                <select id="lang" onchange="cambiarIdioma(this.value)">
                    <option value="es" ${currentLang === 'es' ? 'selected' : ''}>Español</option>
                    <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                    <option value="zh" ${currentLang === 'zh' ? 'selected' : ''}>中文</option>
                </select>
            </div>
        `;
    }

    html += `<h2>${questionData.pregunta}</h2>`;

    // Info para preguntas múltiples
    if (questionData.tipo === 'multiple') {
        const multiSelectText = {
            es: 'Puedes seleccionar múltiples opciones',
            en: 'You can select multiple options',
            zh: '您可以选择多个选项'
        };
        html += `<div class="multi-select-info">${multiSelectText[currentLang]}</div>`;
    }

    // Opciones (con escape para comillas en onclick)
    questionData.opciones.forEach((opcion) => {
        const isSelected = isOptionSelected(realQuestionIndex, opcion);
        const escapedOpcion = opcion.replace(/'/g, "\\'");  // Escape para JS
        html += `<div class="option ${isSelected ? 'selected' : ''}" onclick="seleccionarOpcion(${realQuestionIndex}, '${escapedOpcion}', '${questionData.tipo}')">${opcion}</div>`;
    });

    // Botones
    html += '<div class="button-group">';
    
    // Botón "Anterior"
    if (currentFlowIndex > 0) {
        const backText = {
            es: 'Anterior',
            en: 'Previous',
            zh: '上一个'
        };
        html += `<button class="back-btn" onclick="anteriorPregunta()">${backText[currentLang]}</button>`;
    }

    // Botón "Siguiente"
    const nextText = {
        es: 'Siguiente',
        en: 'Next',
        zh: '下一个'
    };
    html += `<button onclick="siguientePregunta()">${nextText[currentLang]}</button>`;
    html += '</div>';

    // Insertar en el DOM
    document.getElementById('quiz').innerHTML = html;

    // Actualizar progreso
    actualizarProgreso(currentFlowIndex + 1, questionFlow.length);
}


        function isOptionSelected(questionIndex, option) {
            const answer = answers[questionIndex];
            if (Array.isArray(answer)) {
                return answer.includes(option);
            }
            return answer === option;
        }

        function seleccionarOpcion(questionIndex, opcion, tipo) {
            if (tipo === 'multiple') {
                if (!answers[questionIndex]) {
                    answers[questionIndex] = [];
                }
                
                const currentAnswers = answers[questionIndex];
                                const index = currentAnswers.indexOf(opcion);
                
                if (index > -1) {
                    currentAnswers.splice(index, 1);
                    if (currentAnswers.length === 0) {
                        delete answers[questionIndex];  // Opcional: remover si vacío
                    }
                } else {
                    currentAnswers.push(opcion);
                }
            } else {
                answers[questionIndex] = opcion;
            }
            
            mostrarPregunta();  // Actualiza visualmente
        }

        function validarRespuesta() {
            const realQuestionIndex = questionFlow[currentFlowIndex];
            const questionData = getQuestionText(realQuestionIndex);
            const answer = answers[realQuestionIndex];
            
            if (questionData.tipo === 'multiple') {
                return Array.isArray(answer) && answer.length > 0;
            } else {
                return answer !== undefined && answer !== null && answer !== '';
            }
        }

        function siguientePregunta() {
            if (!validarRespuesta()) {
                const alertText = {
                    es: 'Por favor selecciona una opción',
                    en: 'Please select an option',
                    zh: '请选择一个选项'
                };
                alert(alertText[currentLang]);
                return;
            }
            
            const realQuestionIndex = questionFlow[currentFlowIndex];
            
            // Actualizar flujo después de responder pregunta 3 (índice 2)
            if (realQuestionIndex === 2) {
                updateQuestionFlow();
                // Ajustar currentFlowIndex para que apunte al siguiente en el nuevo flow
                currentFlowIndex = 3;  // Después de 0,1,2 -> siguiente es índice 3 en flow
                if (currentFlowIndex >= questionFlow.length) {
                    enviarEncuesta();
                    return;
                }
            } else {
                currentFlowIndex++;
            }
            
            if (currentFlowIndex >= questionFlow.length) {
                enviarEncuesta();
            } else {
                mostrarPregunta();
            }
        }

        function anteriorPregunta() {
            if (currentFlowIndex > 0) {
                currentFlowIndex--;
                mostrarPregunta();
            }
        }

        // Función para mapear respuestas a español y preparar JSON con keys en inglés
        function prepararDatos() {
            const data = {
                idioma: currentLang,
                timestamp: new Date().toISOString(),
                respuestas: {}
            };

            // Para cada campo en el mapeo
            Object.keys(fieldMapping).forEach(indexStr => {
                const index = parseInt(indexStr);
                const fieldKey = fieldMapping[index];
                const answer = answers[index];

                if (answer !== undefined && answer !== null) {
                    const mapper = valueToSpanish[index] || {};  // Mapper para esta pregunta
                    if (Array.isArray(answer)) {
                        // Multiple: mapear cada elemento
                        data.respuestas[fieldKey] = answer.map(opt => mapper[opt] || opt).filter(Boolean);
                    } else {
                        // Single: mapear valor
                        data.respuestas[fieldKey] = mapper[answer] || answer;
                    }
                } else {
                    // No respondida: null
                    data.respuestas[fieldKey] = null;
                }
            });

            return data;
        }

        // Función para enviar encuesta a n8n
           async function enviarEncuesta() {
       const data = prepararDatos();

       // Spinner
       document.getElementById('quiz').innerHTML = '<div class="spinner"><div></div><div></div><div></div></div><p>Enviando datos...</p>';

       try {
           const response = await fetch(N8N_WEBHOOK_URL, {
               method: 'POST',
               mode: 'no-cors',  // <--- AGREGAR ESTO: Ignora CORS, pero no lee response
               headers: {
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify(data)
           });

           // No puedes chequear response.ok con no-cors, así que asume éxito
           console.log('Datos enviados (sin verificación CORS). Verifica en n8n.');
           mostrarFinal(true);  // Siempre muestra éxito

       } catch (error) {
           console.error('Error al enviar:', error);
           mostrarFinal(false, 'Error de conexión. Verifica n8n y prueba con servidor local.');
       }
   }
   

        // Actualizar barra de progreso
        function actualizarProgreso(current, total) {
            const progreso = (current / total) * 100;
            if (document.getElementById("progress")) {
                document.getElementById("progress").style.width = `${progreso}%`;
            }
        }

        // Mensaje final
        function mostrarFinal(success = null, errorMsg = '') {
            let html = `
                <h2>Gracias por responder esta encuesta</h2>
                <div class="final-message">
                      `;

            // Mensaje de éxito o error
            if (success === true) {
                html += `
                    <div class="success-msg">
                        <strong>¡Éxito!</strong> Tus respuestas se enviaron correctamente a nuestra base de datos.
                    </div>
                `;
            } else if (success === false) {
                html += `
                    <div class="error-msg-final">
                        <strong>Error en el envío:</strong> ${errorMsg}. 
                        <p>No te preocupes, puedes reintentar o contactar al administrador si persiste.</p>
                        <button onclick="enviarEncuesta()" style="margin: 5px; background: #2575fc; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Reintentar Envío</button>
                    </div>
                `;
            }

            html += `
                    <ul style="text-align:left;">
                        <li>Si querés o necesitás más información sobre el tema podés:</li>
                        <li>Ingresar a <a href="https://www.saberjugar.gob.ar" target="_blank">https://www.saberjugar.gob.ar</a></li>
                        <li>Centros de ayuda municipal en Chascomús:</li>
                        <ul style="text-align:left; margin-left: 20px; list-style-type: disc;">
                            <li>Centro de Día Chascomús, Dirección Carmona 36, Barrio 30 de Mayo, Tel: 02241-409070, Horarios de Atención de Lunes a Viernes de 08 a 14hs.</li>
                            <li>Centro de Prevención de las Adicciones, Carmona 36, Barrio 30 de Mayo, Horarios de Atención de 09 a 14 hs, Tel: 02241-400278.</li>
                        </ul>
                        <li>Por Urgencias llamar al <b>107</b></li>
                    </ul>
                    ${success === false ? '<button onclick="location.reload()" style="margin-top: 10px; background: #ddd; color: #333; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Recargar y Responder de Nuevo</button>' : ''}
                </div>
            `;

            document.getElementById("quiz").innerHTML = html;
            // Progreso al 100%
            if (document.getElementById("progress")) {
                document.getElementById("progress").style.width = "100%";
            }
        }

        // Inicializar: Mostrar primera pregunta al cargar
            window.onload = function() {
             currentLang = 'es';  // Idioma por defecto
             mostrarPregunta();
        };

    </script>
</body>
</html>

